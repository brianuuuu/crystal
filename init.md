# ğŸ§Š æ°´æ™¶ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ï¼ˆCrystal System Design Documentï¼‰

# 1 èƒŒæ™¯
## 1.1 Role (è§’è‰²)
ä½ æ˜¯ä¸€ä½ç²¾é€š Python (FastAPI)ã€Playwright å’Œ React çš„èµ„æ·±å…¨æ ˆå·¥ç¨‹å¸ˆã€‚

# 1.2 Project Context (é¡¹ç›®èƒŒæ™¯)
æˆ‘ä»¬è¦æ„å»º "Crystal" (æ°´æ™¶)ï¼Œè¿™æ˜¯ä¸€ä¸ªæœåŠ¡äºé‡åŒ–äº¤æ˜“ç³»ç»Ÿçš„è½»é‡çº§èˆ†æƒ…å“¨å¡”å¾®æœåŠ¡ã€‚

éµå¾ªé«˜å†…èšã€ä½è€¦åˆçš„ç¬¬ä¸€æ€§åŸåˆ™ï¼Œæ—¨åœ¨æ„å»ºä¸€ä¸ªç‹¬ç«‹ã€ç¨³å®šã€å¯å›æº¯çš„èˆ†æƒ…å“¨å¡”

**ç›®æ ‡**: æ¯æ—¥ä»ç¤¾äº¤å¹³å°ï¼ˆé›ªçƒã€å¾®åšã€çŸ¥ä¹ï¼‰æŠ“å–èˆ†æƒ…æ•°æ®å¹¶è¿›è¡Œå¯è§†åŒ–å±•ç¤ºã€‚

**æ¶æ„**: æœ¬åœ°è¿è¡Œçš„å•ä½“æ¶æ„ã€‚
- **No Docker**: æ— å®¹å™¨åŒ–ï¼Œç›´æ¥åœ¨å®¿ä¸»æœºè¿è¡Œã€‚
- **Database**: SQLite (æ–‡ä»¶å‹æ•°æ®åº“)ã€‚

# 1.3 Tech Stack (æŠ€æœ¯æ ˆ)
- **Backend**: Python 3.10+, FastAPI, APScheduler, Loguru.
- **Scraping**: Playwright (å¼‚æ­¥ API).
- **Frontend**: React, Vite, Ant Design 5ï¼Œæš—é»‘æ¨¡å¼ (Dark Mode)ï¼Œæå®¢é£

# 2 ç³»ç»Ÿæ€»è§ˆï¼ˆOverviewï¼‰

æ°´æ™¶ï¼ˆCrystalï¼‰æ˜¯ä¸€ä¸ªç‹¬ç«‹è¿è¡Œçš„èˆ†æƒ…é‡‡é›†ä¸å±•ç¤ºç³»ç»Ÿï¼Œæ¯å¤©æ—©ä¸Š **06:00** å¯¹ç”¨æˆ·å…³æ³¨çš„å¯¹è±¡ï¼ˆè´¦å· / å…¬å¸ / å…³é”®è¯ï¼‰åœ¨ï¼š

- å¾®åšï¼ˆWeiboï¼‰
- çŸ¥ä¹ï¼ˆZhihuï¼‰
- é›ªçƒï¼ˆXueqiuï¼‰

äº§ç”Ÿçš„èˆ†æƒ…å†…å®¹è¿›è¡Œä¸Šä¸€è‡ªç„¶æ—¥ç»“ç®—å¼æŠ“å–â†’ æ¸…æ´— â†’ å…¥åº“ â†’ é€šè¿‡ API æä¾›ç»™å¤–éƒ¨æœåŠ¡ï¼Œå¹¶é€šè¿‡ web ç•Œé¢è¿›è¡Œå¯è§†åŒ–æŸ¥çœ‹ã€‚

ç³»ç»ŸåŠŸèƒ½åŒ…å«ï¼š

- å¤šå¹³å°æŠ“å–ï¼ˆHTTP + Playwrightï¼‰
- å¹³å°è´¦å·ç®¡ç†ä¸æ¨¡æ‹Ÿç™»å½•
- å…³æ³¨å¯¹è±¡ watchlist ç®¡ç†
- èˆ†æƒ…æ•°æ®å­˜å‚¨ä¸å»é‡
- æ¯æ—¥èˆ†æƒ…ç»“ç®—ä»»åŠ¡ï¼ˆ06:00ï¼‰
- Web æ—¶é—´è½´å±•ç¤ºï¼ˆå¤šå¹³å°èšåˆ + æ—¥æœŸèŒƒå›´ + å…³é”®å­—æœç´¢ï¼‰
- å¯¹å¤–æä¾› snapshot API

---

# 3 æ¶æ„æ¦‚è§ˆï¼ˆArchitectureï¼‰
```
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  æ°´æ™¶ Web ç•Œé¢ â”‚
             â”‚ /timeline      â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
             é¡¶éƒ¨è´¦å·çŠ¶æ€æ  / èˆ†æƒ…æ—¶é—´è½´å±•ç¤º
                     â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /api å±‚ï¼ˆå¯¹å¤–æä¾›æ¥å£ï¼‰â”‚ â”‚ Web å±‚ï¼ˆReact SPA + é™æ€èµ„æºæ‰˜ç®¡ï¼‰â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚
â–¼ â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Scheduler â”‚ æ¯æ—¥06:00 â”‚ Account Managerâ”‚
â”‚ ä»»åŠ¡ä¸­å¿ƒ â”‚----------------------â†’â”‚ ç™»å½•çŠ¶æ€/æ¨¡æ‹Ÿç™»å½• â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚
â–¼ â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŠ“å–å±‚ï¼ˆCrawlerï¼‰ â”‚
â”‚ WeiboCrawler / ZhihuCrawler / XueqiuCrawler â”‚
â”‚ HTTP + Playwrightï¼ŒåŸºäºè´¦å· Cookie è¿è¡Œ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ ç»“æ„åŒ–èˆ†æƒ…æ•°æ®
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­˜å‚¨å±‚ï¼ˆDBï¼‰ â”‚
â”‚ watch_target â”‚
â”‚ platform_account â”‚
â”‚ sentiment_item â”‚
â”‚ daily_job_run â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
æ³¨æ„ï¼šScheduler ä¸åœ¨ Web è¿›ç¨‹çº¿ç¨‹ä¸­è¿è¡Œ
---

# 4 ä»£ç ç›®å½•ç»“æ„ï¼ˆProject Structureï¼‰

```
crystal/
â”œâ”€â”€ app/
â”‚ â”œâ”€â”€ main.py # FastAPI å…¥å£
â”‚ â”‚
â”‚ â”œâ”€â”€ config/
â”‚ â”‚ â””â”€â”€ settings.py
â”‚ â”‚
â”‚ â”œâ”€â”€ core/
â”‚ â”‚ â”œâ”€â”€ models.py # ORM
â”‚ â”‚ â”œâ”€â”€ schemas.py # Pydantic
â”‚ â”‚ â”œâ”€â”€ sentiment.py
â”‚ â”‚ â””â”€â”€ utils.py
â”‚ â”‚
â”‚ â”œâ”€â”€ crawler/ # æŠ“å–æ¨¡å—ï¼ˆHTTP + Playwrightï¼‰
â”‚ â”‚ â”œâ”€â”€ base.py
â”‚ â”‚ â”œâ”€â”€ weibo.py
â”‚ â”‚ â”œâ”€â”€ zhihu.py
â”‚ â”‚ â””â”€â”€ xueqiu.py
â”‚ â”‚
â”‚ â”œâ”€â”€ storage/
â”‚ â”‚ â”œâ”€â”€ database.py
â”‚ â”‚ â””â”€â”€ repositories.py # æ•°æ®è¯»å†™
â”‚ â”‚
â”‚ â”œâ”€â”€ scheduler/
â”‚ â”‚ â”œâ”€â”€ jobs.py # run_daily_crystal_job
â”‚ â”‚ â””â”€â”€ runner.py # APScheduler
â”‚ â”‚
â”‚ â”œâ”€â”€ api/
â”‚ â”‚ â”œâ”€â”€ router_public.py # snapshotã€health
â”‚ â”‚ â””â”€â”€ router_auth.py # ç™»å½• / è´¦å·çŠ¶æ€æ¥å£
â”‚ â”‚
â”‚ â”œâ”€â”€ web/                  # React + Vite + AntD v5 å‰ç«¯å·¥ç¨‹
â”‚ â”‚   â”œâ”€â”€ src/
â”‚ â”‚   â”œâ”€â”€ index.html
â”‚ â”‚   â”œâ”€â”€ package.json
â”‚ â”‚   â””â”€â”€ vite.config.ts
â”‚ â”‚
â”‚ â””â”€â”€ account/
â”‚ â”œâ”€â”€ manager.py # è´¦å·è¯»å–/æ›´æ–°
â”‚ â””â”€â”€ login_service.py # Playwright æ¨¡æ‹Ÿç™»å½•
â”‚
â”œâ”€â”€ scripts/
â”‚ â””â”€â”€ run_daily_once.py
â”‚
â””â”€â”€ README.md
```

---
# 5 æ•°æ®åº“è¡¨ç»“æ„ï¼ˆDatabase Schemaï¼‰

## 5.1 å¹³å°è´¦å·è¡¨ `platform_account`

ç®¡ç†å„å¹³å°çš„è´¦å·ã€ç™»å½•çŠ¶æ€ä¸ Cookieã€‚

| å­—æ®µ | è¯´æ˜ |
|------|------|
| id | ä¸»é”® |
| platform | weibo / zhihu / xueqiu |
| username | è´¦å·å |
| login_type | password / qrcode / cookie |
| login_status | online / offline / error |
| last_login_at | æœ€è¿‘æˆåŠŸç™»å½•æ—¶é—´ |
| last_error | ç™»å½•é”™è¯¯ä¿¡æ¯ |
| cookies | JSONï¼ˆCookie/Tokenï¼‰ |
| is_active | æ˜¯å¦ç”¨äºæŠ“å– |
| created_at | åˆ›å»ºæ—¶é—´ |
| updated_at | æ›´æ–°æ—¶é—´ |

---

## 5.2 å…³æ³¨ç›®æ ‡è¡¨ `watch_target`

è®°å½•éœ€è¦ç›‘æ§çš„ç”¨æˆ·/æ ‡çš„/å…³é”®è¯ã€‚

| å­—æ®µ | è¯´æ˜ |
|------|------|
| platform | å¹³å° |
| target_type | account / symbol / keyword |
| external_id | uid / é›ªçƒç”¨æˆ· id |
| symbol | è‚¡ç¥¨ä»£ç  |
| keyword | å…³é”®è¯ç›‘æ§ |
| display_name | UI æ˜¾ç¤ºç”¨ |
| enabled | æ˜¯å¦æœ‰æ•ˆ |

---

## 5.3 èˆ†æƒ…è®°å½•è¡¨ `sentiment_item`

æ¯æ—¥æŠ“åˆ°çš„å¸–å­/è¯„è®ºéƒ½ä¼šå­˜å…¥è¿™é‡Œã€‚

| å­—æ®µ | è¯´æ˜ |
|------|------|
| platform | å¹³å° |
| target_id | å…³è” watch_target |
| symbol | è‚¡ç¥¨ä»£ç  |
| root_post_id | ä¸»å¸–ID |
| comment_id | è¯„è®ºIDï¼ˆå”¯ä¸€ï¼‰ |
| author_id / author_name | ä½œè€… |
| content | æ–‡æœ¬ |
| url | åŸæ–‡é“¾æ¥ |
| posted_at | å¹³å°æ—¶é—´ |
| fetched_at | æŠ“å–æ—¶é—´ |
| sentiment_score | æƒ…ç»ªåˆ† |
| heat_score | çƒ­åº¦åˆ† |
| topic | è¯é¢˜ |
| extra | JSON æ‰©å±•å­—æ®µ |

**å”¯ä¸€çº¦æŸï¼š `(platform, comment_id)`**

---

## 5.4 æ¯æ—¥ä»»åŠ¡è¡¨ `daily_job_run`

è®°å½•æ¯å¤©ç»“ç®—ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µã€‚

| å­—æ®µ | è¯´æ˜ |
|------|------|
| date | èˆ†æƒ…çª—å£æ—¥æœŸ |
| platform | all / weibo / zhihu / xueqiu |
| status | pending/running/success/failed/partial |
| total_targets | ç›®æ ‡æ•°é‡ |
| total_items | æŠ“å–æ•°é‡ |
| error_detail | é”™è¯¯æ‘˜è¦ |

---

# 6 ç™»å½•æµç¨‹ï¼ˆLogin Flowï¼‰

1. Web é¡¶éƒ¨æ˜¾ç¤ºè´¦å·çŠ¶æ€ï¼ˆé€šè¿‡ `/api/v1/auth/status`ï¼‰
2. ç”¨æˆ·ç‚¹å‡»â€œç¦»çº¿è´¦å·â€
3. å¼¹å‡ºç™»å½•æ¡†ï¼ˆè¾“å…¥å¯†ç ï¼‰
4. è°ƒç”¨ `POST /api/v1/auth/login`
5. åç«¯è°ƒç”¨ Playwright æ‰§è¡Œæ¨¡æ‹Ÿç™»å½•
6. ç™»å½•æˆåŠŸ â†’ å­˜å‚¨ Cookie + å°† login_status=online
7. çˆ¬è™«åç»­ä½¿ç”¨è¯¥ Cookie è‡ªåŠ¨ç™»å½•

---

# 7 æ¯æ—¥ç»“ç®—ä»»åŠ¡ï¼ˆ06:00ï¼‰

æµç¨‹ï¼š
```
06:00 â†’ run_daily_crystal_job(D)
â†“
åˆ›å»º daily_job_run(all)
â†“
å¯¹ weibo/zhihu/xueqiu åˆ†åˆ«è¿è¡Œï¼š
- è¯»å–åœ¨çº¿è´¦å· cookies
- åŠ è½½ watchlist
- è°ƒ crawler.fetch(...)
- å­˜ sentiment_itemï¼ˆå»é‡ï¼‰
â†“
æ±‡æ€» total_items â†’ æ›´æ–°ä»»åŠ¡çŠ¶æ€
```
æ—¶é—´çª—å£ï¼šç›®æ ‡æ—¥æœŸå½“æ—¥çš„ 00:00:00 ï½ 23:59:59ï¼ˆç»Ÿä¸€ä½¿ç”¨ Asia/Shanghai æ—¶åŒºï¼‰
ä¾‹å¦‚ï¼š2025-12-09 06:00 â†’ æŠ“å– 2025-12-08 çš„å…¨éƒ¨èˆ†æƒ…ã€‚

---

# 8 Web æ—¶é—´è½´ç•Œé¢ï¼ˆTimeline Viewï¼‰

è·¯å¾„ï¼š`/timeline`

### åŠŸèƒ½ï¼š

- é¡¶éƒ¨è´¦å·çŠ¶æ€æ ï¼ˆåœ¨çº¿ / ç¦»çº¿ï¼Œå¯ç‚¹å‡»å¼¹å‡ºç™»å½•æ¡†ï¼‰
- å¹³å° Tabï¼šå…¨éƒ¨ / å¾®åš / çŸ¥ä¹ / é›ªçƒ
- æ—¥æœŸèŒƒå›´é€‰æ‹©ï¼ˆfrom â†’ toï¼‰
- symbol ç­›é€‰
- å…³é”®å­—æœç´¢ï¼šæ¨¡ç³ŠåŒ¹é… content/author/topic
- èˆ†æƒ…è®°å½•æŒ‰æ—¶é—´å€’åºå±•ç¤º

UI è®¾è®¡é£æ ¼ï¼šæç®€ã€ä¿¡æ¯å¯†åº¦é«˜ã€ä¾¿äºä¸€é¡µæ‰«å…¨é‡ã€‚

---

# 9. API æ¥å£ï¼ˆå¯¹å¤–æä¾›ä½¿ç”¨ï¼‰

### 1ï¼‰å¥åº·æ£€æŸ¥
GET /api/v1/health

### 2ï¼‰è´¦å·çŠ¶æ€
GET /api/v1/auth/status

### 3ï¼‰æ¨¡æ‹Ÿç™»å½•
POST /api/v1/auth/login

### 4ï¼‰èˆ†æƒ…å¿«ç…§ï¼ˆæ ¸å¿ƒæ¥å£ï¼‰
GET /api/v1/snapshot?symbol=600036.SH&from=2025-12-01&to=2025-12-08&keyword=è®¢å•

```
è¿”å›ç»“æ„ï¼š

{
  "items": [
    {
      "platform": "xueqiu",
      "symbol": "600036.SH",
      "content": "â€¦â€¦",
      "posted_at": "2025-12-08T10:03:00",
      "author_name": "æŸé›ªçƒç”¨æˆ·",
      "sentiment_score": 0.72,
      "heat_score": 120
    }
  ]
}
```
---
# 10 éç›®æ ‡èŒƒå›´ï¼ˆOut of Scopeï¼‰

ä¸åš AI èˆ†æƒ…åˆ†æ

ä¸åšé‡åŒ–å› å­æ„å»º

ä¸åšäº¤æ˜“ç­–ç•¥

ä¸åšæƒé™ç³»ç»Ÿ

ä¸åšå®æ—¶èˆ†æƒ…ç›‘å¬ï¼ˆé 7Ã—24ï¼‰

---
# 11 æ€»ç»“

æ°´æ™¶ç³»ç»Ÿéœ€è¦å…·å¤‡ï¼š

âœ” å¤šå¹³å°èˆ†æƒ…æŠ“å–ï¼ˆHTTP + Playwrightï¼‰

âœ” å¹³å°è´¦å·çŠ¶æ€ç®¡ç† + æ¨¡æ‹Ÿç™»å½•

âœ” æ¯æ—¥ 06:00 èˆ†æƒ…ç»“ç®—ä»»åŠ¡

âœ” èˆ†æƒ…æ•°æ®åº“ï¼ˆç»“æ„åŒ–å­˜å‚¨ã€å¯é‡è·‘ï¼‰

âœ” Web æ—¶é—´è½´ç•Œé¢ï¼ˆèšåˆ/ç­›é€‰/å…³é”®å­—ï¼‰

âœ” API ä¸ç‰ç’ƒæ‰“é€šï¼ˆsnapshot æä¾›æ•°æ®ï¼‰

æ˜¯ä¸€ä¸ªå¯æŠ•å…¥ç”Ÿäº§çš„å°å‹èˆ†æƒ…ç›‘æµ‹ç³»ç»Ÿ

